<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="../../css/spectre.min.css">
  <style>
    #logs {
      margin-top: 20px;
      padding: 10px;
      background: #f5f5f5;
      border: 1px solid #ccc;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 2px 0;
      padding: 2px;
    }
    .log-error {
      color: red;
      font-weight: bold;
    }
    .log-success {
      color: green;
    }
    .log-info {
      color: blue;
    }
  </style>
</head>
<body>
  <div class="container">
    <h3>LogLog Control</h3>
    <button id="start" class="btn btn-primary">Start Logging</button>
    <button id="stop" class="btn btn-error">Stop Logging</button>
    <button id="status" class="btn btn-secondary">Get Status</button>
    <button id="download" class="btn btn-success">Download Logs</button>
    <button id="clear" class="btn">Clear Logs</button>
    <div id="logs"></div>
  </div>
  
  <script src="../../core/lib/interface.js"></script>
  <script>
    let logContainer = document.getElementById("logs");
    
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
      console.log(message);
    }
    
    function onInit() {
      log("Connected to Bangle.js", "success");
      
      document.getElementById("start").addEventListener("click", () => {
        log("Starting logging...", "info");
        Puck.eval("BangleAppInterface.start()", (result) => {
          log("Response: " + JSON.stringify(result), "success");
        });
      });
      
      document.getElementById("stop").addEventListener("click", () => {
        log("Stopping logging...", "info");
        Puck.eval("BangleAppInterface.stop()", (result) => {
          log("Response: " + JSON.stringify(result), "success");
        });
      });
      
      document.getElementById("status").addEventListener("click", () => {
        log("Getting status...", "info");
        Puck.eval("BangleAppInterface.getStatus()", (result) => {
          log("Status: " + JSON.stringify(result), "info");
          if (result.logging) {
            log("✓ Logging is ACTIVE", "success");
          } else {
            log("✗ Logging is STOPPED", "error");
          }
          log(`Files: ${result.logFiles}, Free storage: ${Math.round(result.freeStorage/1024)}KB`, "info");
        });
      });
      
      document.getElementById("download").addEventListener("click", () => {
        downloadLogs();
      });
      
      document.getElementById("clear").addEventListener("click", () => {
        logContainer.innerHTML = '';
        log("Logs cleared", "info");
      });
    }
    
    function downloadLogs() {
      log("Listing log files...", "info");
      Puck.eval('require("Storage").list(/loglog.*\\.csv/)', (files) => {
        log("Found " + files.length + " log file(s)", "info");
        if (files.length === 0) {
          log("No log files to download", "info");
          return;
        }
        
        files.forEach((fname) => {
          log(`Downloading ${fname}...`, "info");
          Puck.eval(`require("Storage").read("${fname}")`, (data) => {
            const blob = new Blob([data], {type: "text/csv"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fname;
            a.click();
            URL.revokeObjectURL(url);
            log(`Downloaded ${fname} (${data.length} bytes)`, "success");
          });
        });
      });
    }
  </script>
</body>
</html>
