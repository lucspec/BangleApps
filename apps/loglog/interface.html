<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="../../css/spectre.min.css">
</head>
<body>
  <div class="container">
    <h3>LogLog Control</h3>
    <button id="start" class="btn btn-primary">Start Logging</button>
    <button id="stop" class="btn btn-error">Stop Logging</button>
    <button id="status" class="btn btn-secondary">Get Status</button>
    <button id="download" class="btn btn-success">Download Logs</button>
    <div id="output" style="margin-top:20px; font-family:monospace; white-space:pre-wrap;"></div>
  </div>
  
  <script src="../../core/lib/interface.js"></script>
  <script>
    function log(msg) {
      document.getElementById("output").textContent += msg + "\n";
    }
    
    function onInit() {
      log("Connected!");
      
      document.getElementById("start").onclick = () => {
        Puck.write("loglogStart();\n");
        log("Started logging");
      };
      
      document.getElementById("stop").onclick = () => {
        Puck.write("loglogStop();\n");
        log("Stopped logging");
      };
      
      document.getElementById("status").onclick = () => {
        Puck.eval("loglogStatus()", (result) => {
          log("Status: " + JSON.stringify(result, null, 2));
        });
      };
      
      document.getElementById("download").onclick = () => {
        Puck.eval('require("Storage").list(/loglog.*\\.csv/)', (files) => {
          log("Found " + files.length + " files");
          files.forEach((fname) => {
            Puck.eval(`require("Storage").read("${fname}")`, (data) => {
              if (data) {
                const blob = new Blob([data], {type: "text/csv"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = fname;
                a.click();
                URL.revokeObjectURL(url);
                log("Downloaded " + fname + " (" + data.length + " bytes)");
              }
            });
          });
        });
      };
    }
  </script>
</body>
</html>
